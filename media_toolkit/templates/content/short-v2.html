{% extends "base-v2.html" %}

{% block title %}Streszczenie artykuÅ‚u â€” v2.1 (fullscreen panels){% endblock %}
{% block header %}Streszczenie artykuÅ‚u{% endblock %}

{% block extra_styles %}
<style>
  /* Width & overflow fixes (mobile-first) */
  *, *::before, *::after { box-sizing: border-box; }
  .stack { overflow-x: hidden; }
  .panel { max-inline-size: 100%; box-sizing: border-box; overflow-wrap: anywhere; }
  .panel input[type="url"], .panel input[type="text"], .panel select, .panel textarea { inline-size: 100%; max-inline-size: 100%; }

  /*
   * v2.1 â€” Fullscreen panels, smooth snap, light/dark themes, mobile-first
   * Design tokens via CSS variables for easy theming.
   */
  :root {
    /* Light as default; dark applied by [data-theme="dark"] */
    --bg: #f6f7fb;
    --bg-elev: #ffffff;
    --text: #0f172a;
    --text-muted: #475569;
    --brand-1: #0b3d91;  /* primary */
    --brand-2: #2563eb;  /* accent */
    --border: rgba(2, 6, 23, 0.08);
    --shadow: 0 10px 30px rgba(2, 6, 23, 0.08);
    --focus: #22d3ee;
  }
  :root[data-theme="dark"] {
    --bg: #030712;
    --bg-elev: rgba(15,23,42,0.9);
    --text: #e2e8f0;
    --text-muted: #94a3b8;
    --brand-1: #0ea5e9;  /* primary */
    --brand-2: #7c3aed;  /* accent */
    --border: rgba(148,163,184,0.2);
    --shadow: 0 24px 48px rgba(2,6,23,0.6);
    --focus: #38bdf8;
  }

  /* Make base background follow theme */
  body { background: var(--bg); color: var(--text); }
  header, footer { background: linear-gradient(135deg, var(--brand-1), #111827 85%); color:#f8fafc; }
  a { color: var(--brand-1); }

  /* Layout: fullscreen vertical carousel with scroll snap */
  main { padding: 0; }
  .shell {
    /* Header height is set to the CSS var from script to keep panels full-screen under sticky header */
    --header-h: 64px;
    block-size: 100svh; /* mobile safe viewport */
    inline-size: 100%;
    overflow: hidden; /* contain momentum scroll */
    background: var(--bg);
  }
  .stack {
    block-size: 100%;
    overflow-y: auto;
    scroll-snap-type: y mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scroll-padding-block-start: 0;
  }
  .panel {
    position: relative;
    inline-size: min(960px, 100%);
    margin-inline: auto;
    /* Subtract header height so panel content fully fits on screen */
    min-block-size: calc(100svh - var(--header-h));
    padding: clamp(16px, 4vw, 28px);
    display: grid;
    align-content: center;
    gap: 18px;
    background: var(--bg-elev);
    border: 1px solid var(--border);
    border-radius: clamp(18px, 4vw, 28px);
    box-shadow: var(--shadow);
    scroll-snap-align: start;
    scroll-snap-stop: always;
    margin-block: clamp(8px, 1.4vh, 16px);
  }
  .panel h2 { margin: 0 0 8px; font-size: clamp(1.25rem, 2.8vw, 1.6rem); font-weight: 750; }
  .muted { color: var(--text-muted); }

  /* Form elements */
  label { font-weight: 600; font-size: 0.98rem; }
  input[type="url"], input[type="text"], select, textarea {
    width: 100%;
    max-inline-size: 100%;
    inline-size: 100%;
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 14px 16px;
    background: color-mix(in oklab, var(--bg) 92%, black 0%);
    color: var(--text);
    font-size: 1rem;
    outline: none;
    box-shadow: inset 0 0 0 1px transparent;
    transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
  }
  textarea { min-block-size: 200px; resize: vertical; }
  input:focus, select:focus, textarea:focus {
    border-color: var(--focus);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--focus), transparent 70%);
  }

  /* Buttons */
  .btn { border: 0; border-radius: 16px; padding: 14px 16px; font-weight: 700; cursor: pointer; }
  .btn:active { transform: translateY(1px); }
  .btn-primary { background: linear-gradient(135deg, var(--brand-1), var(--brand-2)); color: #f8fafc; }
  .btn-ghost { background: transparent; color: var(--text); border: 1px solid var(--border); }

  /* Action bar (fixed) */
  .fab-nav {
    position: fixed; inset-inline: 0; bottom: 14px;
    display: flex; justify-content: center; gap: 10px; pointer-events: none;
    z-index: 40;
  }
  .fab-nav button {
    pointer-events: auto;
    width: 52px; height: 52px; border-radius: 999px; border: 1px solid var(--border);
    background: var(--bg-elev); color: var(--text);
    box-shadow: var(--shadow);
    font-size: 1.2rem; line-height: 0; display:grid; place-items:center;
  }

  /* Step dots */
  .dots { position: fixed; inset-inline-end: 10px; inset-block-start: 50%; translate: 0 -50%; display: grid; gap: 8px; z-index: 35; }
  .dot { width: 10px; height: 10px; border-radius: 999px; background: color-mix(in oklab, var(--text), transparent 70%); opacity:.5; }
  .dot.active { background: var(--brand-1); opacity: 1; }

  /* Archive grid on larger screens */
  @media (min-width: 780px) {
    .archive-list { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; }
  }

  /* Reduce motion accessibility */
  @media (prefers-reduced-motion: reduce) {
    .stack { scroll-behavior: auto; }
    .btn:active { transform: none; }
  }
</style>
{% endblock %}

{% block content %}
<script>window.MEDIA_TOOLKIT_PREFIX = "{{ media_toolkit_prefix|default('') }}";</script>
<div class="shell" id="shell">
  <div class="stack" id="stack">

    <!-- PANEL 1: FORM -->
    <section class="panel" aria-label="Formularz streszczenia">
      <header style="display:flex; align-items:end; justify-content:space-between; gap:12px; margin-block-end:8px;">
        <h2>StreÅ›Ä‡ artykuÅ‚</h2>
        <div class="inline" style="display:flex; gap:8px; align-items:center;">
          <button type="button" id="themeToggle" class="btn btn-ghost" aria-pressed="false" title="PrzeÅ‚Ä…cz motyw">ðŸŒ“</button>
        </div>
      </header>

      <form id="mobileForm" novalidate style="display:grid; gap:14px;">
        <div>
          <label for="mobile-url">Adres URL</label>
          <input id="mobile-url" type="url" placeholder="https://â€¦" required inputmode="url" autocomplete="url">
        </div>
        <div>
          <label for="mobile-prompt">DÅ‚ugoÅ›Ä‡ streszczenia</label>
          <select id="mobile-prompt" required>
            <option value="">â€” wybierz â€”</option>
            {% for prompt in prompts %}
              <option value="{{ prompt.id }}">{{ prompt.label }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <label class="muted" for="mobile-tts" style="display:flex; align-items:center; gap:10px;">
            <input id="mobile-tts" type="checkbox" style="transform:scale(1.2); accent-color: var(--brand-1);">
            Nagraj narracjÄ™ (TTS)
          </label>
          <span id="mobileStatus" class="muted" aria-live="polite"></span>
        </div>
        <div style="display:grid; gap:10px; grid-template-columns: 1fr 1fr;">
          <button id="mobileFetch" class="btn btn-primary" type="submit">StreÅ›Ä‡ mi to</button>
          <button id="mobileReuse" class="btn btn-ghost" type="button">UÅ¼yj ponownie</button>
        </div>
      </form>
    </section>

    <!-- PANEL 2: RESULT -->
    <section class="panel" aria-label="Wynik">
      <h2>Wynik</h2>
      <input id="mobile-title" type="text" readonly placeholder="TytuÅ‚">
      <textarea id="mobile-text" readonly placeholder="Tekst"></textarea>
      <audio id="mobile-audio" controls class="hidden" style="width:100%; border-radius:16px;"></audio>
      <p class="muted" style="margin:0;">PrzesuÅ„ w dÃ³Å‚, aby zobaczyÄ‡ archiwum â¤µ</p>
    </section>

    <!-- PANEL 3: ARCHIVE -->
    <section class="panel" aria-label="Archiwum">
      <h2>Archiwum</h2>
      <div id="mobileArchive" class="archive-list"></div>
      <p class="muted">Brak wpisÃ³w? Wygeneruj pierwsze streszczenie w panelu pierwszym.</p>
    </section>

  </div>

  <!-- Floating navigation + dots -->
  <div class="fab-nav" aria-hidden="false">
    <button type="button" id="prevBtn" title="Poprzedni panel" aria-label="Poprzedni panel">â†‘</button>
    <button type="button" id="nextBtn" title="NastÄ™pny panel" aria-label="NastÄ™pny panel">â†“</button>
  </div>
  <div class="dots" aria-hidden="true">
    <div class="dot" data-i="0"></div>
    <div class="dot" data-i="1"></div>
    <div class="dot" data-i="2"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // --- Size-aware header height for perfect full-viewport panels
  (function setHeaderHeightVar(){
    const header = document.querySelector('header');
    const root = document.querySelector('#shell');
    function update(){
      const h = header ? header.offsetHeight : 64;
      root?.style.setProperty('--header-h', h + 'px');
    }
    update();
    new ResizeObserver(update).observe(document.body);
    window.addEventListener('orientationchange', () => setTimeout(update, 300));
  })();

  const stack = document.getElementById('stack');
  const panels = [...document.querySelectorAll('.panel')];
  const dots = [...document.querySelectorAll('.dot')];
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  function activeIndex(){
    // Find the panel closest to top
    const top = stack.scrollTop;
    let idx = 0, min = Infinity;
    panels.forEach((p, i) => {
      const d = Math.abs(p.offsetTop - top);
      if (d < min) { min = d; idx = i; }
    });
    return idx;
  }
  function goto(i){
    const clamped = Math.max(0, Math.min(i, panels.length - 1));
    panels[clamped].scrollIntoView({ behavior: 'smooth', block: 'start' });
    setTimeout(updateDots, 160);
  }
  function updateDots(){
    const idx = activeIndex();
    dots.forEach((d, i) => d.classList.toggle('active', i === idx));
  }
  stack.addEventListener('scroll', () => {
    // Throttle updates a bit
    if (stack._raf) cancelAnimationFrame(stack._raf);
    stack._raf = requestAnimationFrame(updateDots);
  });
  prevBtn.addEventListener('click', () => goto(activeIndex() - 1));
  nextBtn.addEventListener('click', () => goto(activeIndex() + 1));
  updateDots();

  // --- Theme toggle with persistence
  const toggle = document.getElementById('themeToggle');
  const THEME_KEY = 'mtk-theme';
  function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); }
  const pref = localStorage.getItem(THEME_KEY) || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  applyTheme(pref);
  toggle.setAttribute('aria-pressed', String(pref === 'dark'));
  toggle.addEventListener('click', () => {
    const now = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    applyTheme(now);
    localStorage.setItem(THEME_KEY, now);
    toggle.setAttribute('aria-pressed', String(now === 'dark'));
  });
</script>

<script>
  // --- App logic (adapted from v2.0, kept minimal & compatible)
  const statusBox = document.getElementById('mobileStatus');
  const urlInput = document.getElementById('mobile-url');
  const promptSelect = document.getElementById('mobile-prompt');
  const titleField = document.getElementById('mobile-title');
  const textField = document.getElementById('mobile-text');
  const audioEl = document.getElementById('mobile-audio');
  const form = document.getElementById('mobileForm');
  const reuseBtn = document.getElementById('mobileReuse');
  const ttsCheckbox = document.getElementById('mobile-tts');
  const archiveEl = document.getElementById('mobileArchive');
  const mobileFetch = document.getElementById('mobileFetch');

  let lastPayload = null;

  const API_PREFIX = (window.MEDIA_TOOLKIT_PREFIX || '').replace(/\/$/, '');
  const api = (path) => `${API_PREFIX}${path.startsWith('/') ? '' : '/'}${path}`;

  function setStatus(message, isError=false) {
    statusBox.textContent = message || '';
    statusBox.style.color = isError ? '#ef4444' : 'var(--text-muted)';
  }

  const prefix = window.MEDIA_TOOLKIT_PREFIX || '';
  const joinPath = (path) => {
    if (!path) return path;
    if (path.startsWith('http://') || path.startsWith('https://')) return path;
    if (prefix && path.startsWith(prefix)) return path;
    if (!path.startsWith('/')) path = `/${path}`;
    return prefix ? `${prefix}${path}` : path;
  };

  const endpoints = {
    scrap: joinPath('{{ url_for("content_tools.scrap_url") }}'),
    apply: joinPath('{{ url_for("content_tools.apply_prompt") }}'),
    archive: joinPath('{{ url_for("content_tools.archive_list") }}'),
    text: '{{ url_for("content_tools.archive_text", entry_id='ENTRY_ID') }}',
    audio: '{{ url_for("content_tools.archive_audio", entry_id='ENTRY_ID') }}',
  };

  async function fetchJSON(url, options) {
    const doFetch = async (u, opt) => fetch(u, opt);
    let res = await doFetch(url, options);
    if (!res.ok && url.startsWith('/media_toolkit/')) {
      const noPrefix = url.replace(/^\/media_toolkit/, '');
      res = await doFetch(noPrefix, options);
    }
    if (!res.ok) {
      const text = await res.text().catch(()=>'');
      throw new Error(`${res.status} ${res.statusText}${text?` â€” ${text.slice(0,160)}`:''}`);
    }
    const ct = (res.headers.get('content-type')||'').toLowerCase();
    if (!ct.includes('application/json')) {
      const head = (await res.text()).replace(/\s+/g,' ').slice(0,200);
      throw new Error(`NieprawidÅ‚owa odpowiedÅº serwera: ${head}`);
    }
    return res.json();
  }

  async function scrap(u) {
    setStatus('Pobieram artykuÅ‚â€¦');
    return fetchJSON(endpoints.scrap, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url: u }),
    });
  }

  async function applyPrompt(promptId, data, tts) {
    setStatus('GenerujÄ™ streszczenieâ€¦');
    return fetchJSON(endpoints.apply, {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ prompt_id: promptId, data, text_to_speech: tts }),
    });
  }

  function buildArchive(entries) {
    if (!archiveEl) return;
    archiveEl.innerHTML = '';
    if (!entries.length) { archiveEl.innerHTML = '<div class="muted">Brak zapisanych wpisÃ³w.</div>'; return; }
    entries.forEach(entry => {
      const card = document.createElement('article');
      card.style.border = `1px solid var(--border)`;
      card.style.borderRadius = '14px';
      card.style.padding = '12px';
      card.style.background = 'color-mix(in oklab, var(--bg), black 0%)';

      const name = document.createElement('div');
      name.innerHTML = `<strong>${entry.title || '(bez tytuÅ‚u)'}</strong>`;
      const meta = document.createElement('div');
      meta.className = 'muted';
      const when = new Date(entry.created_at).toLocaleString();
      meta.textContent = [entry.prompt_id, when].filter(Boolean).join(' â€¢ ');

      const actions = document.createElement('div');
      actions.style.display = 'flex'; actions.style.flexWrap = 'wrap'; actions.style.gap = '10px'; actions.style.marginTop = '8px';

      const textLink = document.createElement('a');
      textLink.className = 'btn btn-ghost'; textLink.textContent = 'Pobierz tekst';
      textLink.href = entry.text_url ? joinPath(entry.text_url) : joinPath(endpoints.text.replace('ENTRY_ID', encodeURIComponent(entry.id)));
      textLink.target = '_blank';
      actions.appendChild(textLink);

      if (entry.audio_url) {
        const playBtn = document.createElement('button');
        playBtn.className = 'btn btn-ghost'; playBtn.textContent = 'OdtwÃ³rz audio';
        playBtn.onclick = () => playAudio(entry.audio_url);
        actions.appendChild(playBtn);
      }

      card.appendChild(name);
      card.appendChild(meta);
      card.appendChild(actions);
      archiveEl.appendChild(card);
    });
  }

  async function loadArchive() {
    const data = await fetchJSON(endpoints.archive, { headers: { 'Accept': 'application/json' } });
    if (!data.ok) throw new Error(data.error || 'Archiwum niedostÄ™pne');
    buildArchive(data.entries || []);
  }

  async function handleSubmit(evt, reuse = false) {
    if (evt) evt.preventDefault();
    const btn = evt.submitter || mobileFetch;
    disableBtn(btn);

    const urlVal = urlInput.value.trim();
    const promptId = promptSelect.value.trim();
    const wantsTts = !!ttsCheckbox?.checked;
    if (!urlVal) { setStatus('Podaj adres URL.', true); enableBtn(btn); return; }
    if (!promptId) { setStatus('Wybierz prompt.', true); enableBtn(btn); return; }

    try {
      if (audioEl) { audioEl.pause(); audioEl.classList.add('hidden'); audioEl.removeAttribute('src'); }
      if (!reuse) {
        const scraped = await scrap(urlVal);
        if (!scraped.ok) throw new Error(scraped.error || 'Nie udaÅ‚o siÄ™ pobraÄ‡ danych.');
        lastPayload = scraped.payload || {};
        titleField.value = lastPayload.title || '';
        textField.value = lastPayload.text || '';
      }
      if (!lastPayload) throw new Error('Brak danych wejÅ›ciowych.');

      const payload = { source_url: urlVal, title: lastPayload.title || '', text: lastPayload.text || '', media: Array.isArray(lastPayload.media) ? lastPayload.media : [], language: 'pl' };
      const result = await applyPrompt(promptId, payload, wantsTts);
      if (!result.ok) throw new Error(result.error || 'BÅ‚Ä…d modelu');

      titleField.value = result.result_title || payload.title || '';
      textField.value = result.result_text || '';
      lastPayload = { title: titleField.value, text: textField.value };

      if (result.audio_base64) { playAudio(`data:audio/mp3;base64,${result.audio_base64}`); }
      else if (result.audio_url) { playAudio(result.audio_url); }

      setStatus(result.audio_error ? `Tekst gotowy. Audio: ${result.audio_error}` : 'Gotowe. Wynik zapisano w archiwum.');
      await loadArchive();
      // Jump to result panel for nice flow
      panels[1].scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch (error) {
      console.error(error);
      setStatus(error.message || 'WystÄ…piÅ‚ bÅ‚Ä…d.', true);
    } finally { enableBtn(btn); }
  }

  function disableBtn(el, label = 'PracujÄ™â€¦') {
    if (!el) return; el.dataset._label = (el.tagName === 'INPUT') ? el.value : el.textContent;
    if (el.tagName === 'A') { el.classList.add('is-disabled'); el.setAttribute('aria-disabled', 'true'); el.style.pointerEvents = 'none'; el.textContent = label; }
    else { el.disabled = true; if (el.tagName === 'INPUT') el.value = label; else el.textContent = label; }
  }
  function enableBtn(el){ if (!el) return; if (el.tagName === 'A') { el.classList.remove('is-disabled'); el.removeAttribute('aria-disabled'); el.style.pointerEvents = ''; el.textContent = el.dataset._label || el.textContent; } else { el.disabled = false; if (el.tagName === 'INPUT') el.value = el.dataset._label || el.value; else el.textContent = el.dataset._label || el.textContent; } delete el.dataset._label; }

  function playAudio(url){
    if (!audioEl) return;
    if (String(url).startsWith('data:')) { audioEl.src = url; audioEl.classList.remove('hidden'); audioEl.play().catch(()=>{}); return; }
    fetch(url, { credentials: 'include' }).then(r=>r.blob()).then(b=>{ audioEl.src = URL.createObjectURL(b); audioEl.classList.remove('hidden'); audioEl.play().catch(()=>{}); });
  }

  form.addEventListener('submit', evt => handleSubmit(evt, false));
  reuseBtn.addEventListener('click', evt => handleSubmit(evt, true));
  loadArchive().catch(()=>{});
</script>
{% endblock %}
